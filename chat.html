<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<body>

<table border="1">
<thead>
<td>Time</td>
<td>User</td>
<td>Message</td>
</thead>
<tbody id="messages"></tbody>
</table>

<div id="message-box" />
	<input type="text" id="message" />
	<input type="submit" id="send" value="Send" />
</div>
<div id="login-box">
	<input type="text" id="user" />
	<input type="password" id="password" />
	<input type="submit" id="login" value="Login" />
</div>
<div>
	<input type="submit" id="connect" value="Connect" />
	<input type="submit" id="disconnect" value="Disconnect" />
	<input type="submit" id="logout" value="Logout" />
</div>
<div id="status">Status: <span id="online" style="color:red;">Disconnected</span> [<span id="online-users"></span>]</div>
<div id="error" style="color: red;"></div>
<script>
	var ws = null;
	var user = null;
	$(document).ready(function() {
		$("#disconnect").hide();
		$("#logout").hide();
		$("#message-box").hide();
		$("#login-box").hide();
		$("#send").attr('disabled', 'disabled');
		$("#message").attr('disabled', 'disabled');
		$("#send").click(function() {
			var message = $("#message").val();
			if (!$("#message").is(":disabled") && message !== "") {
				$("#message").attr('disabled', 'disabled');
				$("#send").attr('disabled', 'disabled');
				ws.send("msg:" + message);
			}
			else {
				$("#error").html("Error: No Message");
				$("#message").focus();
			}
		});
		$(document).keypress(function(e) {
			if (e.which == 13) {
				if ($("#message").is(":focus")) {
					$("#send").trigger("click");
				}
				else if($("#user").is(":focus") || $("#password").is(":focus")) {
					$("#login").trigger("click");
				}
			}
		});
		$(window).on("beforeunload", function() {
			ws.onclose = function() {};
			ws.close();
		});
		
		connect();
	});
        $("#connect").click(function() {
		connect();
        });
        $("#disconnect").click(function() {
		ws.close();
        });
	$("#login").click(function() {
		ws.send("login:" + $("#user").val() + ":" + $("#password").val());
	});
	$("#logout").click(function() {
		ws.send("logout");
	});
	function connect() {
		ws = new WebSocket('ws://public.project-umbrella.com:8081');

		ws.onopen = function(e) {
			$("#online").html("Connected (not logged in)");
			$("#online").css({"color": "orange"});
			$("#connect").hide();
			$("#disconnect").show();
			$("#login-box").show();
		}

		ws.onmessage = function(e) {
			var args = e.data.split(':');
			switch (args[0]) {
				case "msgb": {
					$("#messages").append("<tr><td class=\"time\">" + args[1] + "</td><td class=\"user\">" + args[2] + "</td><td class=\"message\">" + args.slice(5).join(":") + "</td></tr>");
					if (args[2] == user) {
						$("#message").removeAttr('disabled');
						$("#send").removeAttr('disabled');
						$("#message").val("");
						$("#message").focus();
					}
					break;
                                }
				case "auth": {
					user = args[1];
					$("#online").html("Connected (logged in as '" + user + "')");
					$("#online").css({"color": "green"});
					$("#message").removeAttr('disabled');
					$("#send").removeAttr('disabled');
					$("#message-box").show();
					$("#logout").show();
					$("#message").focus();
					$("#login-box").hide();
					break;
				}
				case "unauth": {
					user = null;
					$("#login-box").show();
					$("#message").attr('disabled', 'disabled');
					$("#send").attr('disabled', 'disabled');
					$("#message-box").hide();
					$("#messages").html("");
					$("#logout").hide();
					$("#error").html(args[1]);
					break;
				}
				case "c": {
					$("#online-users").html(args[1]);
					break;
				}
			}
		}

		ws.onclose = function(e) {
			$("#online").html("Disconnected");
			$("#online").css({"color": "red"});
			$("#message").attr('disabled', 'disabled');
			$("#send").attr('disabled', 'disabled');
			$("#messages").html("");
			$("#disconnect").hide();
			$("#connect").show();
			$("#message-box").hide();
			$("#login-box").hide();
			$("#logout").hide();
			ws = null;
		}
	}
	
</script>
